stages:
  - build
  - deploy

cache:
  paths:
    - node_modules/

build_dev:
  image: docker.art.code.pan.run/build-tools--image-node:16.ep1
  rules:
    - if: $CI_MERGE_REQUEST_IID
  stage: build
  artifacts:
    paths:
      - public
  environment: dev
  variables:
    NODE_TLS_REJECT_UNAUTHORIZED: 0
  script:
    - yarn config set "strict-ssl" false
    - yarn install
    - yarn run build
    - mv build public

deploy_preview:
  image: docker.art.code.pan.run/build-tools--image-gcp-utils:1.0.2
  stage: deploy
  rules:
    - if: $CI_MERGE_REQUEST_IID
  environment:
    name: dev
    url: https://pandev-${GITLAB_USER_ID}-${CI_MERGE_REQUEST_IID}-dot-tryingpan.uc.r.appspot.com
  script:
    - gcloud auth activate-service-account --key-file $GOOGLE_APPLICATION_CREDENTIALS
    - gcloud auth list --filter=status:ACTIVE --format="value(account)"
    - gcloud app deploy public/app.yaml --project $GCP_PROJECT_ID --no-promote --quiet --version pandev-${GITLAB_USER_ID}-${CI_MERGE_REQUEST_IID}
